<!DOCTYPE HTML>
<html lang="en" class="rust sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Oracle Integration (CITL) - DECY: C-to-Rust Transpiler Verification Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="Comprehensive verification and testing documentation for the DECY C-to-Rust transpiler, following EXTREME TDD methodology">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "rust";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('rust')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">DECY: C-to-Rust Transpiler Verification Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/noahgift/decy" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/noahgift/decy/edit/main/book/src/advanced/oracle.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="oracle-integration-citl"><a class="header" href="#oracle-integration-citl">Oracle Integration (CITL)</a></h1>
<p>Decy integrates with entrenar's CITL (Compiler-in-the-Loop Training) system to automatically learn and apply fixes for common rustc errors during C-to-Rust transpilation.</p>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<p>The oracle system implements the <strong>Jidoka</strong> principle from the Toyota Way: automation with human intelligence. When transpilation produces rustc errors, the oracle:</p>
<ol>
<li>Queries accumulated fix patterns from previous successful repairs</li>
<li>Suggests fixes ranked by confidence score</li>
<li>Applies fixes automatically when confidence exceeds threshold</li>
<li>Captures verified fixes for future use</li>
</ol>
<p>This creates a feedback loop where the transpiler becomes more effective over time.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<pre><code>┌─────────────────────────────────────────────────────────────────┐
│                      DECY ORACLE PIPELINE                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  C Source ──► Parser ──► HIR ──► Ownership ──► Codegen ──► Rust │
│                                      │                     │     │
│                                      ▼                     ▼     │
│                              ┌─────────────┐        ┌──────────┐ │
│                              │   ORACLE    │◄───────│  rustc   │ │
│                              │   QUERY     │        │  errors  │ │
│                              └─────────────┘        └──────────┘ │
│                                    │                             │
│                                    ▼                             │
│                           ┌───────────────┐                      │
│                           │ .apr Patterns │                      │
│                           │ (Fix Library) │                      │
│                           └───────────────┘                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
</code></pre>
<h2 id="decision-categories"><a class="header" href="#decision-categories">Decision Categories</a></h2>
<p>The oracle classifies C-to-Rust decisions into categories that map to specific rustc error codes:</p>
<h3 id="ownership-inference"><a class="header" href="#ownership-inference">Ownership Inference</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>C Pattern</th><th>Rust Target</th><th>Common Errors</th></tr></thead><tbody>
<tr><td>PointerOwnership</td><td><code>*T</code></td><td><code>Box&lt;T&gt;</code>, <code>&amp;T</code>, <code>&amp;mut T</code></td><td>E0382, E0499, E0506</td></tr>
<tr><td>ArrayOwnership</td><td><code>T[]</code></td><td><code>Vec&lt;T&gt;</code>, <code>&amp;[T]</code>, <code>Box&lt;[T]&gt;</code></td><td>E0382, E0499, E0506</td></tr>
<tr><td>StringOwnership</td><td><code>char*</code></td><td><code>String</code>, <code>&amp;str</code>, <code>CString</code></td><td>E0382, E0308</td></tr>
</tbody></table>
</div>
<h3 id="lifetime-inference"><a class="header" href="#lifetime-inference">Lifetime Inference</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Decision</th><th>Common Errors</th></tr></thead><tbody>
<tr><td>LifetimeElision</td><td>Elide vs explicit <code>'a</code></td><td>E0597, E0515</td></tr>
<tr><td>StructLifetime</td><td>Field lifetime annotations</td><td>E0597, E0515</td></tr>
<tr><td>ReturnLifetime</td><td>Return reference binding</td><td>E0515, E0597</td></tr>
</tbody></table>
</div>
<h3 id="unsafe-minimization"><a class="header" href="#unsafe-minimization">Unsafe Minimization</a></h3>
<div class="table-wrapper"><table><thead><tr><th>Category</th><th>Decision</th><th>Common Errors</th></tr></thead><tbody>
<tr><td>UnsafeBlock</td><td>When <code>unsafe</code> is required</td><td>E0133</td></tr>
<tr><td>RawPointerCast</td><td><code>*const T</code> → <code>&amp;T</code> safety</td><td>E0133, E0606</td></tr>
<tr><td>NullCheck</td><td><code>NULL</code> → <code>Option&lt;T&gt;</code></td><td>E0308</td></tr>
</tbody></table>
</div>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<h3 id="basic-oracle-transpilation"><a class="header" href="#basic-oracle-transpilation">Basic Oracle Transpilation</a></h3>
<pre><code class="language-bash"># Enable oracle with default threshold (0.7)
decy transpile --oracle input.c -o output.rs
</code></pre>
<h3 id="auto-fix-mode"><a class="header" href="#auto-fix-mode">Auto-Fix Mode</a></h3>
<pre><code class="language-bash"># Automatically apply fixes above confidence threshold
decy transpile --oracle --auto-fix input.c -o output.rs
</code></pre>
<h3 id="adjust-confidence-threshold"><a class="header" href="#adjust-confidence-threshold">Adjust Confidence Threshold</a></h3>
<pre><code class="language-bash"># Higher threshold = more conservative
decy transpile --oracle --auto-fix --oracle-threshold 0.9 input.c

# Lower threshold = more aggressive
decy transpile --oracle --auto-fix --oracle-threshold 0.5 input.c
</code></pre>
<h3 id="pattern-capture-learning-mode"><a class="header" href="#pattern-capture-learning-mode">Pattern Capture (Learning Mode)</a></h3>
<pre><code class="language-bash"># Capture verified fixes for future use
decy transpile --oracle --auto-fix --capture input.c -o output.rs
</code></pre>
<p>When <code>--capture</code> is enabled:</p>
<ol>
<li>Fixes that lead to successful compilation are recorded</li>
<li>Patterns are saved to the <code>.apr</code> pattern library</li>
<li>Future transpilations benefit from learned patterns</li>
</ol>
<h2 id="cross-project-pattern-transfer"><a class="header" href="#cross-project-pattern-transfer">Cross-Project Pattern Transfer</a></h2>
<p>The oracle supports sharing patterns between projects (Yokoten principle):</p>
<pre><code class="language-bash"># Project A: Build pattern library
decy transpile-project --oracle --auto-fix --capture \
    ./project-a -o ./output-a

# Project B: Import patterns from A
decy transpile-project --oracle --import-patterns ./project-a.apr \
    ./project-b -o ./output-b
</code></pre>
<h3 id="transferable-error-codes"><a class="header" href="#transferable-error-codes">Transferable Error Codes</a></h3>
<p>Not all patterns transfer well between projects. The oracle only imports patterns for universal ownership/lifetime errors:</p>
<div class="table-wrapper"><table><thead><tr><th>Error Code</th><th>Description</th><th>Transferable</th></tr></thead><tbody>
<tr><td>E0382</td><td>Borrow of moved value</td><td>Yes</td></tr>
<tr><td>E0499</td><td>Multiple mutable borrows</td><td>Yes</td></tr>
<tr><td>E0506</td><td>Cannot assign to borrowed</td><td>Yes</td></tr>
<tr><td>E0597</td><td>Does not live long enough</td><td>Yes</td></tr>
<tr><td>E0515</td><td>Cannot return reference to local</td><td>Yes</td></tr>
<tr><td>E0308</td><td>Type mismatch</td><td>No (project-specific)</td></tr>
<tr><td>E0133</td><td>Unsafe required</td><td>No (context-specific)</td></tr>
</tbody></table>
</div>
<h2 id="ci-integration"><a class="header" href="#ci-integration">CI Integration</a></h2>
<h3 id="json-output"><a class="header" href="#json-output">JSON Output</a></h3>
<pre><code class="language-bash">decy transpile --oracle --oracle-report json input.c
</code></pre>
<p>Output:</p>
<pre><code class="language-json">{
  "metrics": {
    "queries": 10,
    "hits": 8,
    "misses": 2,
    "fixes_applied": 8,
    "fixes_verified": 7
  },
  "hit_rate_pct": 80.0,
  "fix_success_rate_pct": 87.5,
  "passed": true,
  "thresholds": {
    "min_hit_rate": 0.5,
    "min_fix_rate": 0.8
  }
}
</code></pre>
<h3 id="markdown-output"><a class="header" href="#markdown-output">Markdown Output</a></h3>
<pre><code class="language-bash">decy transpile --oracle --oracle-report markdown input.c &gt; report.md
</code></pre>
<p>Output:</p>
<pre><code class="language-markdown">## Oracle CI Report

| Metric | Value |
|--------|-------|
| Queries | 10 |
| Hits | 8 |
| Hit Rate | 80.0% |
| Fixes Applied | 8 |
| Fixes Verified | 7 |
| Fix Success Rate | 87.5% |

### Status: PASSED
</code></pre>
<h3 id="prometheus-output"><a class="header" href="#prometheus-output">Prometheus Output</a></h3>
<pre><code class="language-bash">decy transpile --oracle --oracle-report prometheus input.c
</code></pre>
<p>Output:</p>
<pre><code># HELP decy_oracle_queries_total Total oracle queries
# TYPE decy_oracle_queries_total counter
decy_oracle_queries_total 10

# HELP decy_oracle_hit_rate Current hit rate
# TYPE decy_oracle_hit_rate gauge
decy_oracle_hit_rate 0.8
</code></pre>
<h3 id="github-actions-example"><a class="header" href="#github-actions-example">GitHub Actions Example</a></h3>
<pre><code class="language-yaml">name: Transpile with Oracle

on: [push, pull_request]

jobs:
  transpile:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install decy
        run: cargo install decy --features oracle

      - name: Transpile with oracle
        run: |
          decy transpile-project \
            --oracle \
            --auto-fix \
            --capture \
            --oracle-report markdown \
            ./src -o ./rust-src &gt; oracle-report.md

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: oracle-report
          path: oracle-report.md
</code></pre>
<h2 id="metrics"><a class="header" href="#metrics">Metrics</a></h2>
<p>The oracle tracks several metrics for observability:</p>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Description</th></tr></thead><tbody>
<tr><td><code>queries</code></td><td>Total oracle queries made</td></tr>
<tr><td><code>hits</code></td><td>Queries that returned suggestions</td></tr>
<tr><td><code>misses</code></td><td>Queries with no matching patterns</td></tr>
<tr><td><code>fixes_applied</code></td><td>Fixes that were applied</td></tr>
<tr><td><code>fixes_verified</code></td><td>Fixes that compiled successfully</td></tr>
<tr><td><code>patterns_captured</code></td><td>New patterns learned</td></tr>
<tr><td><code>patterns_imported</code></td><td>Patterns loaded from external .apr</td></tr>
</tbody></table>
</div>
<h3 id="hit-rate"><a class="header" href="#hit-rate">Hit Rate</a></h3>
<pre><code>hit_rate = hits / queries
</code></pre>
<p>Target: &gt;= 50% (improves as patterns accumulate)</p>
<h3 id="fix-success-rate"><a class="header" href="#fix-success-rate">Fix Success Rate</a></h3>
<pre><code>fix_success_rate = fixes_verified / fixes_applied
</code></pre>
<p>Target: &gt;= 80% (indicates pattern quality)</p>
<h2 id="building-with-oracle-support"><a class="header" href="#building-with-oracle-support">Building with Oracle Support</a></h2>
<p>The oracle requires the <code>oracle</code> feature flag:</p>
<pre><code class="language-bash"># Build with oracle
cargo build --features oracle

# Run tests with oracle
cargo test --features oracle

# Install with oracle
cargo install decy --features oracle
</code></pre>
<h2 id="pattern-file-format"><a class="header" href="#pattern-file-format">Pattern File Format</a></h2>
<p>Patterns are stored in <code>.apr</code> files (Aprender binary format with zstd compression). These files are managed automatically by the oracle but can be:</p>
<ul>
<li>Copied between machines</li>
<li>Shared via version control</li>
<li>Imported from other PAIML transpilers (depyler, bashrs)</li>
</ul>
<h2 id="troubleshooting"><a class="header" href="#troubleshooting">Troubleshooting</a></h2>
<h3 id="no-patterns-found"><a class="header" href="#no-patterns-found">No patterns found</a></h3>
<pre><code>Oracle Statistics:
Queries: 10
Fixes applied: 0
</code></pre>
<p><strong>Solution</strong>: Run with <code>--capture</code> to build initial pattern library, or import patterns from another project.</p>
<h3 id="low-hit-rate"><a class="header" href="#low-hit-rate">Low hit rate</a></h3>
<pre><code>Hit Rate: 20%
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Import patterns: <code>--import-patterns base.apr</code></li>
<li>Run more transpilations with <code>--capture</code></li>
<li>Lower threshold: <code>--oracle-threshold 0.5</code></li>
</ol>
<h3 id="fixes-not-compiling"><a class="header" href="#fixes-not-compiling">Fixes not compiling</a></h3>
<pre><code>Fix Success Rate: 40%
</code></pre>
<p><strong>Solutions</strong>:</p>
<ol>
<li>Raise threshold: <code>--oracle-threshold 0.8</code></li>
<li>Patterns may be project-specific; rebuild pattern library</li>
<li>Check for project-specific type definitions</li>
</ol>
<h2 id="oracle-training"><a class="header" href="#oracle-training">Oracle Training</a></h2>
<p>The oracle learns from transpilation errors through a structured training pipeline. This section covers the CLI commands and workflow for training.</p>
<h3 id="training-cli-commands"><a class="header" href="#training-cli-commands">Training CLI Commands</a></h3>
<pre><code class="language-bash"># Seed oracle with patterns from another project (cross-project transfer)
decy oracle seed --from ../depyler/depyler.apr

# Show oracle statistics
decy oracle stats
decy oracle stats --format json
decy oracle stats --format prometheus

# Retire obsolete patterns (Kaizen - continuous improvement)
decy oracle retire --dry-run
decy oracle retire --archive-path ./retired-patterns.apr

# Validate oracle on a corpus
decy oracle validate ./corpus/
</code></pre>
<h3 id="training-workflow"><a class="header" href="#training-workflow">Training Workflow</a></h3>
<p>The recommended training workflow follows Toyota Way principles:</p>
<h4 id="phase-1-bootstrap-yokoten"><a class="header" href="#phase-1-bootstrap-yokoten">Phase 1: Bootstrap (Yokoten)</a></h4>
<p><strong>Option A: Cold Start Bootstrap</strong> (Recommended for new installations)</p>
<p>Use the built-in bootstrap patterns for common C→Rust errors:</p>
<pre><code class="language-bash"># Preview available bootstrap patterns
decy oracle bootstrap --dry-run

# Bootstrap the oracle with seed patterns
decy oracle bootstrap

# Verify patterns loaded
decy oracle stats
</code></pre>
<p>This loads 25+ predefined patterns for errors like:</p>
<ul>
<li>E0308 (type mismatch): pointer_to_reference, type_coercion</li>
<li>E0133 (unsafe): unsafe_deref, unsafe_extern</li>
<li>E0382 (use after move): clone_before_move, borrow_instead_of_move</li>
<li>E0499 (multiple mutable borrows): sequential_mutable_borrow</li>
<li>E0597/E0515 (lifetime): extend_lifetime, return_owned</li>
</ul>
<p><strong>Option B: Cross-Project Import</strong></p>
<p>Seed the oracle with patterns from related projects:</p>
<pre><code class="language-bash"># Import ownership/lifetime patterns from depyler (Python→Rust)
decy oracle seed --from ../depyler/depyler.apr

# Check import statistics
decy oracle stats
</code></pre>
<p><strong>Smart Import Filtering</strong>: Not all patterns transfer between languages. The oracle's smart import filter:</p>
<ul>
<li>Accepts: <code>AddBorrow</code>, <code>AddLifetime</code> patterns (universal)</li>
<li>Filters: Python-specific patterns (list cloning, etc.)</li>
<li>Warns: Ambiguous patterns for manual review</li>
</ul>
<h4 id="phase-2-corpus-training-genchi-genbutsu"><a class="header" href="#phase-2-corpus-training-genchi-genbutsu">Phase 2: Corpus Training (Genchi Genbutsu)</a></h4>
<p>Train on real C code using the reprorusted-c-cli corpus:</p>
<pre><code class="language-bash"># Clone training corpus
git clone https://github.com/paiml/reprorusted-c-cli ../reprorusted-c-cli

# Validate corpus diversity
decy oracle validate ../reprorusted-c-cli/coreutils/

# Train with pattern capture
decy transpile-project \
    --oracle \
    --auto-fix \
    --capture \
    ../reprorusted-c-cli/coreutils/ \
    -o ./output/
</code></pre>
<h4 id="phase-3-validation-jidoka"><a class="header" href="#phase-3-validation-jidoka">Phase 3: Validation (Jidoka)</a></h4>
<p>Verify fix quality with semantic validation:</p>
<pre><code class="language-bash"># Run validation on held-out corpus
decy oracle validate ./test-corpus/

# Check metrics
decy oracle stats --format markdown
</code></pre>
<p><strong>Semantic Verification</strong>: Patterns must pass both:</p>
<ol>
<li><strong>Compilation check</strong>: <code>rustc</code> compiles without errors</li>
<li><strong>Test suite check</strong>: Unit tests pass (when available)</li>
</ol>
<p>Patterns that only compile get weight 0.6; fully verified patterns get weight 1.0.</p>
<h4 id="phase-4-maintenance-kaizen"><a class="header" href="#phase-4-maintenance-kaizen">Phase 4: Maintenance (Kaizen)</a></h4>
<p>Retire obsolete patterns periodically:</p>
<pre><code class="language-bash"># Preview retirements
decy oracle retire --dry-run

# Apply retirements
decy oracle retire --archive-path ./archive/retired-$(date +%Y%m%d).apr
</code></pre>
<p><strong>Retirement Policy</strong>:</p>
<ul>
<li>Low usage: &lt; 5 uses in 30 days</li>
<li>High failure: &lt; 30% success rate</li>
<li>Superseded: Better pattern exists with &gt; 20% improvement</li>
</ul>
<h3 id="corpus-diversity-validation"><a class="header" href="#corpus-diversity-validation">Corpus Diversity Validation</a></h3>
<p>The oracle validates training corpus diversity using Jensen-Shannon divergence:</p>
<pre><code class="language-bash">decy oracle validate ./corpus/
</code></pre>
<p>Output:</p>
<pre><code>=== Corpus Diversity Analysis ===
Files: 19
Lines of code: 6180

C Construct Coverage:
  RawPointer: 45
  MallocFree: 23
  Struct: 18
  ForLoop: 67
  Switch: 12

=== Validation Results ===
Files processed: 19
Transpile success: 15
Transpile failed: 4
Success rate: 78.9%

Error Distribution:
  E0382: 3 (Ownership)
  E0597: 1 (Lifetime)

✅ Corpus diversity validation: PASSED
</code></pre>
<p><strong>Acceptance Criteria</strong>: Jensen-Shannon divergence &lt; 0.15 between training corpus and external validation corpora.</p>
<h3 id="training-metrics"><a class="header" href="#training-metrics">Training Metrics</a></h3>
<p>Monitor training progress with these metrics:</p>
<div class="table-wrapper"><table><thead><tr><th>Metric</th><th>Target</th><th>Description</th></tr></thead><tbody>
<tr><td>Hit Rate</td><td>≥ 50%</td><td>Queries returning suggestions</td></tr>
<tr><td>Fix Success Rate</td><td>≥ 80%</td><td>Fixes that compile successfully</td></tr>
<tr><td>Full Verification Rate</td><td>≥ 60%</td><td>Fixes passing tests</td></tr>
<tr><td>Pattern Count</td><td>Growing</td><td>Accumulated patterns</td></tr>
<tr><td>Retirement Rate</td><td>&lt; 10%</td><td>Patterns retired per sweep</td></tr>
</tbody></table>
</div>
<h3 id="example-training-on-reprorusted-c-cli"><a class="header" href="#example-training-on-reprorusted-c-cli">Example: Training on reprorusted-c-cli</a></h3>
<p>Complete training workflow:</p>
<pre><code class="language-bash"># 1. Clone corpus
git clone https://github.com/paiml/reprorusted-c-cli ../reprorusted-c-cli

# 2. Bootstrap oracle (cold start)
decy oracle bootstrap
decy oracle stats

# 3. Train on coreutils
for util in ../reprorusted-c-cli/coreutils/*/; do
    echo "Training on: $util"
    decy transpile-project \
        --oracle \
        --auto-fix \
        --capture \
        "$util" \
        -o "./trained-output/$(basename $util)/"
done

# 4. Check results
decy oracle stats --format markdown

# 5. Validate on held-out set
decy oracle validate ../reprorusted-c-cli/validation/

# 6. Retire low-quality patterns
decy oracle retire --dry-run
</code></pre>
<h2 id="ai-first-model-training"><a class="header" href="#ai-first-model-training">AI-First Model Training</a></h2>
<p>Decy's oracle supports generating training data for LLM fine-tuning. The goal is to train a model that "intuits" safe C-to-Rust transformations.</p>
<h3 id="golden-traces"><a class="header" href="#golden-traces">Golden Traces</a></h3>
<p>Golden Traces are verified C→Rust transformation pairs used as training data:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct GoldenTrace {
    pub c_snippet: String,       // Input C code
    pub rust_snippet: String,    // Verified safe Rust output
    pub safety_explanation: String, // Chain-of-thought reasoning
    pub tier: TraceTier,         // P0/P1/P2 complexity
}
<span class="boring">}</span></code></pre></pre>
<h3 id="generating-training-data"><a class="header" href="#generating-training-data">Generating Training Data</a></h3>
<pre><code class="language-bash"># Generate Golden Traces from a C corpus
decy oracle generate-traces \
    --corpus ./c-corpus \
    --output ./traces.jsonl \
    --tier P0

# Preview without writing (dry run)
decy oracle generate-traces \
    --corpus ./c-corpus \
    --output ./traces.jsonl \
    --dry-run
</code></pre>
<p><strong>Training Tiers</strong>:</p>
<div class="table-wrapper"><table><thead><tr><th>Tier</th><th>Complexity</th><th>Examples</th></tr></thead><tbody>
<tr><td>P0</td><td>Simple</td><td>Type casts, basic functions</td></tr>
<tr><td>P1</td><td>Medium</td><td>File I/O, format strings</td></tr>
<tr><td>P2</td><td>Complex</td><td>Ownership, lifetimes, concurrency</td></tr>
</tbody></table>
</div>
<h3 id="querying-fix-patterns"><a class="header" href="#querying-fix-patterns">Querying Fix Patterns</a></h3>
<p>Look up fix patterns for specific rustc error codes:</p>
<pre><code class="language-bash"># Query patterns for type mismatch errors
decy oracle query --error E0308

# Query with context for better matches
decy oracle query --error E0382 --context "let x = value; use(x);"

# Get JSON output for tooling integration
decy oracle query --error E0308 --format json
</code></pre>
<p><strong>Supported Error Codes</strong>:</p>
<div class="table-wrapper"><table><thead><tr><th>Code</th><th>Description</th><th>Pattern Count</th></tr></thead><tbody>
<tr><td>E0308</td><td>Type mismatch</td><td>12+ patterns</td></tr>
<tr><td>E0133</td><td>Unsafe required</td><td>3+ patterns</td></tr>
<tr><td>E0382</td><td>Use after move</td><td>5+ patterns</td></tr>
<tr><td>E0499</td><td>Multiple mutable borrows</td><td>3+ patterns</td></tr>
<tr><td>E0597</td><td>Lifetime issues</td><td>4+ patterns</td></tr>
</tbody></table>
</div>
<h3 id="export-to-huggingface"><a class="header" href="#export-to-huggingface">Export to HuggingFace</a></h3>
<p>Export patterns in ML-ready formats:</p>
<pre><code class="language-bash"># JSONL format (default)
decy oracle export ./patterns.jsonl --format jsonl

# ChatML format for chat fine-tuning
decy oracle export ./patterns.chatml --format chatml

# Alpaca format
decy oracle export ./patterns.alpaca --format alpaca

# Generate dataset card
decy oracle export ./patterns.jsonl --format jsonl --with-card
</code></pre>
<h3 id="training-workflow-1"><a class="header" href="#training-workflow-1">Training Workflow</a></h3>
<p>Complete workflow for generating model training data:</p>
<pre><code class="language-bash"># 1. Bootstrap with seed patterns
decy oracle bootstrap

# 2. Generate traces from corpus
decy oracle generate-traces \
    --corpus ./reprorusted-c-cli \
    --output ./golden-traces.jsonl \
    --tier P0

# 3. Export to HuggingFace format
decy oracle export ./dataset.jsonl --format jsonl --with-card

# 4. View statistics
decy oracle stats --format markdown
</code></pre>
<h2 id="related-documentation"><a class="header" href="#related-documentation">Related Documentation</a></h2>
<ul>
<li><a href="../reference/cli.html">CLI Reference</a> - Complete command reference</li>
<li><a href="https://github.com/paiml/entrenar">entrenar CITL</a> - Pattern storage system</li>
<li><a href="../../docs/specifications/decy-unified-spec.html">Unified Specification</a> - Full technical specification</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../advanced/ml-features.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../advanced/debugging.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../advanced/ml-features.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../advanced/debugging.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script>
            window.playground_line_numbers = true;
        </script>

        <script>
            window.playground_copyable = true;
        </script>

        <script src="../ace.js"></script>
        <script src="../editor.js"></script>
        <script src="../mode-rust.js"></script>
        <script src="../theme-dawn.js"></script>
        <script src="../theme-tomorrow_night.js"></script>

        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
