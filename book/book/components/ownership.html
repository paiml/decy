<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Ownership Inference</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ownership-inference"><a class="header" href="#ownership-inference">Ownership Inference</a></h1>
<p>Ownership inference determines which Rust ownership pattern (owning, borrowed, or raw) best represents each C pointer.</p>
<h2 id="ownership-patterns"><a class="header" href="#ownership-patterns">Ownership Patterns</a></h2>
<h3 id="three-categories"><a class="header" href="#three-categories">Three Categories</a></h3>
<pre><code class="language-rust ignore">#[derive(Debug, Clone, PartialEq)]
pub enum OwnershipPattern {
    // Variable owns its data (Box&lt;T&gt;)
    Owning,

    // Variable borrows data (&amp;T or &amp;mut T)
    Borrowed,

    // Unsafe raw pointer (*const T or *mut T)
    Raw,
}</code></pre>
<h3 id="pattern-mapping"><a class="header" href="#pattern-mapping">Pattern Mapping</a></h3>
<div class="table-wrapper"><table><thead><tr><th>C Pattern</th><th>Ownership</th><th>Rust Type</th></tr></thead><tbody>
<tr><td><code>malloc</code> → variable</td><td>Owning</td><td><code>Box&lt;T&gt;</code></td></tr>
<tr><td>Function parameter pointer</td><td>Borrowed</td><td><code>&amp;T</code> or <code>&amp;mut T</code></td></tr>
<tr><td>Returned pointer</td><td>Owning</td><td><code>Box&lt;T&gt;</code></td></tr>
<tr><td>Pointer arithmetic</td><td>Raw</td><td><code>*mut T</code></td></tr>
<tr><td>NULL checks</td><td>Borrowed</td><td><code>Option&lt;&amp;T&gt;</code></td></tr>
</tbody></table>
</div>
<h2 id="inference-algorithm"><a class="header" href="#inference-algorithm">Inference Algorithm</a></h2>
<h3 id="step-1-classify-by-source"><a class="header" href="#step-1-classify-by-source">Step 1: Classify by Source</a></h3>
<pre><code class="language-rust ignore">fn classify_by_source(var: &amp;str, graph: &amp;DataflowGraph) -&gt; OwnershipPattern {
    let source = graph.get_source(var);

    match source {
        Source::Malloc =&gt; OwnershipPattern::Owning,
        Source::Parameter =&gt; OwnershipPattern::Borrowed,
        Source::AddressOf(_) =&gt; OwnershipPattern::Borrowed,
        Source::PointerArithmetic =&gt; OwnershipPattern::Raw,
        _ =&gt; OwnershipPattern::Raw,
    }
}</code></pre>
<h3 id="verification-test"><a class="header" href="#verification-test">Verification Test</a></h3>
<pre><code class="language-rust ignore">#[test]
fn test_malloc_is_owning() {
    let c_code = "int* p = malloc(sizeof(int));";

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let ownership = infer_ownership(&amp;graph);

    assert_eq!(ownership.get("p"), Some(&amp;OwnershipPattern::Owning));
}

#[test]
fn test_parameter_is_borrowed() {
    let c_code = "void func(int* p) { *p = 10; }";

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let ownership = infer_ownership(&amp;graph);

    assert_eq!(ownership.get("p"), Some(&amp;OwnershipPattern::Borrowed));
}</code></pre>
<h2 id="mutability-inference"><a class="header" href="#mutability-inference">Mutability Inference</a></h2>
<p>Determine if borrows should be mutable:</p>
<pre><code class="language-rust ignore">fn infer_mutability(var: &amp;str, graph: &amp;DataflowGraph) -&gt; bool {
    // Check if variable is ever assigned to
    for node in graph.nodes() {
        if let DataflowNode::Assign { target, .. } = node {
            if target == var {
                return true;  // Mutable
            }
        }
        if let DataflowNode::Dereference { var: v } = node {
            if v == var &amp;&amp; graph.is_lvalue(node) {
                return true;  // Mutable (used as lvalue)
            }
        }
    }
    false  // Immutable
}</code></pre>
<h3 id="verification-test-1"><a class="header" href="#verification-test-1">Verification Test</a></h3>
<pre><code class="language-rust ignore">#[test]
fn test_infer_mutable_borrow() {
    let c_code = "void increment(int* p) { *p = *p + 1; }";

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let analysis = OwnershipAnalysis::new(&amp;graph);

    let info = analysis.analyze_variable("p").unwrap();

    assert_eq!(info.pattern, OwnershipPattern::Borrowed);
    assert!(info.is_mutable);  // Should be &amp;mut, not &amp;
}

#[test]
fn test_infer_immutable_borrow() {
    let c_code = "int get_value(const int* p) { return *p; }";

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let analysis = OwnershipAnalysis::new(&amp;graph);

    let info = analysis.analyze_variable("p").unwrap();

    assert_eq!(info.pattern, OwnershipPattern::Borrowed);
    assert!(!info.is_mutable);  // Should be &amp;, not &amp;mut
}</code></pre>
<h2 id="confidence-scoring"><a class="header" href="#confidence-scoring">Confidence Scoring</a></h2>
<p>Assign confidence to each inference:</p>
<pre><code class="language-rust ignore">#[derive(Debug, Clone)]
pub struct OwnershipInfo {
    pub pattern: OwnershipPattern,
    pub is_mutable: bool,
    pub confidence: f64,  // 0.0 to 1.0
    pub reasoning: Vec&lt;String&gt;,
}

fn calculate_confidence(var: &amp;str, graph: &amp;DataflowGraph) -&gt; f64 {
    let mut confidence = 0.5;  // Start neutral

    // Strong indicators increase confidence
    if has_malloc_call(var, graph) {
        confidence += 0.4;  // malloc → definitely owning
    }
    if is_function_parameter(var, graph) {
        confidence += 0.3;  // parameters → likely borrowed
    }

    // Weak indicators
    if has_null_check(var, graph) {
        confidence += 0.1;
    }

    confidence.min(1.0)
}</code></pre>
<h3 id="verification-test-2"><a class="header" href="#verification-test-2">Verification Test</a></h3>
<pre><code class="language-rust ignore">#[test]
fn test_confidence_scores() {
    let test_cases = vec![
        ("int* p = malloc(sizeof(int));", 0.9),  // High confidence
        ("void func(int* p) {}", 0.8),            // High confidence
        ("int* p;", 0.5),                         // Low confidence (unknown)
    ];

    for (c_code, expected_min_confidence) in test_cases {
        let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
        let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
        let analysis = OwnershipAnalysis::new(&amp;graph);
        let info = analysis.analyze_variable("p").unwrap();

        assert!(
            info.confidence &gt;= expected_min_confidence,
            "Expected confidence ≥ {}, got {}",
            expected_min_confidence,
            info.confidence
        );
    }
}</code></pre>
<h2 id="property-tests"><a class="header" href="#property-tests">Property Tests</a></h2>
<h3 id="property-malloc-always-owning"><a class="header" href="#property-malloc-always-owning">Property: malloc Always Owning</a></h3>
<pre><code class="language-rust ignore">use proptest::prelude::*;

proptest! {
    #[test]
    fn prop_malloc_always_owning(var_name in "[a-z]+", size in 1..1024usize) {
        let c_code = format!("{}* {} = malloc({});", "int", var_name, size);

        let hir = lower_to_hir(&amp;parse(&amp;c_code).unwrap()).unwrap();
        let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
        let ownership = infer_ownership(&amp;graph);

        // Property: All malloc allocations are owning
        prop_assert_eq!(
            ownership.get(&amp;var_name),
            Some(&amp;OwnershipPattern::Owning)
        );
    }
}</code></pre>
<h3 id="property-function-parameters-borrowed"><a class="header" href="#property-function-parameters-borrowed">Property: Function Parameters Borrowed</a></h3>
<pre><code class="language-rust ignore">proptest! {
    #[test]
    fn prop_parameters_borrowed(
        func_name in "[a-z]+",
        param_name in "[a-z]+",
    ) {
        let c_code = format!(
            "void {}(int* {}) {{ *{} = 0; }}",
            func_name, param_name, param_name
        );

        let hir = lower_to_hir(&amp;parse(&amp;c_code).unwrap()).unwrap();
        let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
        let ownership = infer_ownership(&amp;graph);

        // Property: Function parameters are borrowed
        prop_assert_eq!(
            ownership.get(&amp;param_name),
            Some(&amp;OwnershipPattern::Borrowed)
        );
    }
}</code></pre>
<h2 id="escape-analysis"><a class="header" href="#escape-analysis">Escape Analysis</a></h2>
<p>Determine if a variable escapes its scope:</p>
<pre><code class="language-rust ignore">fn escapes_scope(var: &amp;str, graph: &amp;DataflowGraph) -&gt; bool {
    for node in graph.nodes() {
        if let DataflowNode::Return(expr) = node {
            if expr.contains_var(var) {
                return true;  // Returned from function
            }
        }
        if let DataflowNode::Call { args, .. } = node {
            if args.contains(&amp;var.to_string()) {
                return true;  // Passed to another function
            }
        }
    }
    false
}</code></pre>
<h3 id="verification-test-3"><a class="header" href="#verification-test-3">Verification Test</a></h3>
<pre><code class="language-rust ignore">#[test]
fn test_escaping_variable() {
    let c_code = r#"
        int* create_int() {
            int* p = malloc(sizeof(int));
            return p;  // p escapes!
        }
    "#;

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let analysis = OwnershipAnalysis::new(&amp;graph);
    let info = analysis.analyze_variable("p").unwrap();

    assert!(info.escapes_scope);
    assert_eq!(info.pattern, OwnershipPattern::Owning);
}

#[test]
fn test_non_escaping_variable() {
    let c_code = r#"
        void process() {
            int* p = malloc(sizeof(int));
            free(p);  // p does not escape
        }
    "#;

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let analysis = OwnershipAnalysis::new(&amp;graph);
    let info = analysis.analyze_variable("p").unwrap();

    assert!(!info.escapes_scope);
}</code></pre>
<h2 id="reasoning-trace"><a class="header" href="#reasoning-trace">Reasoning Trace</a></h2>
<p>Provide human-readable explanations:</p>
<pre><code class="language-rust ignore">#[test]
fn test_inference_reasoning() {
    let c_code = "int* p = malloc(sizeof(int));";

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let analysis = OwnershipAnalysis::new(&amp;graph);
    let info = analysis.analyze_variable("p").unwrap();

    assert_eq!(info.pattern, OwnershipPattern::Owning);
    assert!(info.reasoning.contains(&amp;"Allocated with malloc".to_string()));
    assert!(info.reasoning.contains(&amp;"No evidence of borrowing".to_string()));
}</code></pre>
<h2 id="integration-test"><a class="header" href="#integration-test">Integration Test</a></h2>
<p>Complete ownership inference pipeline:</p>
<pre><code class="language-rust ignore">#[test]
fn test_end_to_end_ownership_inference() {
    let c_code = r#"
        int* create_and_modify(int* input) {
            int* output = malloc(sizeof(int));
            *output = *input * 2;
            return output;
        }
    "#;

    let hir = lower_to_hir(&amp;parse(c_code).unwrap()).unwrap();
    let graph = DataflowGraph::from_hir(&amp;hir).unwrap();
    let ownership = infer_ownership(&amp;graph);

    // input: borrowed (parameter, not modified)
    assert_eq!(
        ownership.get("input"),
        Some(&amp;OwnershipPattern::Borrowed)
    );

    // output: owning (malloc, returned)
    assert_eq!(
        ownership.get("output"),
        Some(&amp;OwnershipPattern::Owning)
    );
}</code></pre>
<h2 id="summary"><a class="header" href="#summary">Summary</a></h2>
<p>Ownership inference provides:</p>
<p>✅ <strong>Pattern classification</strong>: Owning, Borrowed, or Raw
✅ <strong>Mutability detection</strong>: &amp;T vs &amp;mut T
✅ <strong>Confidence scoring</strong>: How certain is the inference?
✅ <strong>Escape analysis</strong>: Does the variable leave its scope?
✅ <strong>Reasoning traces</strong>: Why was this pattern chosen?</p>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<ul>
<li><a href="./borrow.html">Borrow Generation</a> - Converting inferred patterns to Rust code</li>
<li><a href="./lifetime.html">Lifetime Analysis</a> - Determining lifetime annotations</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../components/dataflow.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../components/borrow.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../components/dataflow.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../components/borrow.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->



    </div>
    </body>
</html>
